<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <!-- æ·»åŠ å…§å®¹å®‰å…¨ç­–ç•¥ -->
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; connect-src 'self'"
  />
  <head>
    <meta charset="UTF-8" />
    <title>Java å³æ™‚ç·¨è­¯å™¨</title>

    <!-- å¼•å…¥ CodeMirror çš„æ¨£å¼å’Œè…³æœ¬ -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/codemirror.min.css"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/theme/dracula.min.css"
      crossorigin="anonymous"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/codemirror.min.js"
      crossorigin="anonymous"
    ></script>
    <!-- ä¿®æ­£ä¸ºæ­£ç¡®çš„Javaæ¨¡å¼è·¯å¾„ -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/mode/clike/clike.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- å¼•å…¥è‡ªå‹•å®Œæˆæ’ä»¶ - ä¿®æ­£å¼•ç”¨è·¯å¾‘ -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/addon/hint/show-hint.css"
      crossorigin="anonymous"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/addon/hint/show-hint.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/addon/hint/anyword-hint.js"
      crossorigin="anonymous"
    ></script>
    <style>
      /* æ•´é«”é é¢èƒŒæ™¯å’Œå­—é«” */
      body {
        font-family: "Arial", sans-serif;
        background-color: #2d2d2d;
        color: #f8f8f2;
        margin: 0;
        padding: 0;
      }

      /* é¡¯ç¤ºå…§å®¹å€åŸŸ */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* é çœ‰æ¨£å¼ */
      header {
        text-align: center;
        padding: 20px 0;
      }

      h1 {
        font-size: 2.5rem;
        color: #f8f8f2;
      }

      /* ç·¨è¼¯å™¨å€åŸŸ */
      .editor-container {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 20px;
      }

      /* ç¨‹å¼ç¢¼å€å¡Š */
      .code-section,
      .output-section {
        flex: 1;
        padding: 20px;
        background-color: #3a3a3a;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h3 {
        color: #f8f8f2;
        font-size: 1.5rem;
        margin-bottom: 10px;
      }

      /* CodeMirrorç·¨è¼¯å™¨å¤–è§€ */
      #code {
        width: 100%;
        height: 400px;
        border: none;
        background-color: #1e1e1e;
        color: #f8f8f2;
        font-size: 1rem;
        padding: 10px;
        border-radius: 4px;
        resize: none;
      }

      /* æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
      .controls {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .controls button {
        padding: 10px 15px;
        border: none;
        background-color: #8e44ad;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }

      .controls button:hover {
        background-color: #9b59b6;
      }

      /* åŸ·è¡Œçµæœå€ */
      .output-section pre {
        background-color: #2c3e50;
        padding: 20px;
        border-radius: 8px;
        color: #f8f8f2;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* é è…³ */
      .footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        background-color: #3a3a3a;
        color: #f8f8f2;
        border-top: 2px solid #8e44ad;
      }

      /* è‡ªè¨‚å½ˆçª— */
      .custom-alert {
        display: none;
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #3a3a3a;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        min-width: 300px;
        text-align: center;
        animation: fadeIn 0.3s ease;
      }

      .custom-alert-content {
        margin-bottom: 15px;
        color: #f8f8f2;
        font-size: 1.1rem;
      }

      .custom-alert-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #50fa7b;
      }

      .custom-alert button {
        padding: 8px 16px;
        background-color: #8e44ad;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s;
      }

      .custom-alert button:hover {
        background-color: #9b59b6;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -60%);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }

      /* é®ç½©å±¤ */
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      /* è¤‡è£½å’Œä¸‹è¼‰æŒ‰éˆ•æ¨£å¼ */
      .action-btn {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .action-btn i {
        font-size: 1.2rem;
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media screen and (max-width: 768px) {
        /* ç·¨è¼¯å™¨å€åŸŸ */
        .editor-container {
          flex-direction: column;
          gap: 20px;
        }

        /* æ§åˆ¶æŒ‰éˆ•èª¿æ•´ */
        .controls {
          flex-direction: row;
          justify-content: center;
          flex-wrap: wrap;
        }

        /* ç·¨è¼¯å™¨é«˜åº¦èª¿æ•´ */
        #code {
          height: 300px;
        }
      }

      @media screen and (max-width: 480px) {
        h1 {
          font-size: 2rem;
        }

        h3 {
          font-size: 1.2rem;
        }

        .controls button {
          font-size: 0.9rem;
          padding: 8px 12px;
        }

        .custom-alert {
          min-width: 250px;
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Java ç¨‹å¼ç·¨è­¯å™¨</h1>
      </header>

      <div class="editor-container">
        <div class="code-section">
          <h3>ç·¨å¯«ç¨‹å¼ç¢¼</h3>
          <form id="codeForm">
            <!-- ä½¿ç”¨ CodeMirror åˆå§‹åŒ– -->
            <textarea id="code" rows="15" cols="80">
public class Main {
    public static void main(String[] args) {
        // ç¯„ä¾‹è¼¸å‡º
        System.out.println("Hello World!");
    }
}</textarea
            >
            <div class="controls">
              <button type="submit">åŸ·è¡Œ</button>
              <button type="button" id="clearBtn">æ¸…é™¤</button>
              <!-- <button type="button" id="formatBtn">æ ¼å¼åŒ–</button> -->
              <button type="button" id="copyBtn" class="action-btn">
                è¤‡è£½ç¨‹å¼ç¢¼
              </button>
              <button type="button" id="downloadBtn" class="action-btn">
                ä¸‹è¼‰ç¨‹å¼ç¢¼
              </button>
            </div>
          </form>
        </div>

        <div class="output-section">
          <h3>åŸ·è¡Œçµæœ</h3>
          <pre id="output">// ç¨‹å¼è¼¸å‡ºå°‡é¡¯ç¤ºåœ¨é€™è£¡</pre>
        </div>
      </div>

      <div class="footer">
        Â© 2025 Java å³æ™‚ç·¨è­¯å™¨ | æŒ‰ Ctrl+Space å•Ÿç”¨ä»£ç¢¼è£œå…¨
      </div>
    </div>

    <!-- è‡ªè¨‚å½ˆçª— -->
    <div class="overlay" id="overlay"></div>
    <div class="custom-alert" id="customAlert">
      <div class="custom-alert-icon">âœ“</div>
      <div class="custom-alert-content" id="alertContent">æ“ä½œæˆåŠŸï¼</div>
      <button id="alertOkBtn">ç¢ºå®š</button>
    </div>

    <script>
      // åˆå§‹åŒ– CodeMirror ç·¨è¼¯å™¨
      var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        mode: "text/x-java", // ä½¿ç”¨ clike æ¨¡å¼ä¸‹çš„ Java
        theme: "dracula",
        matchBrackets: true,
        autoCloseBrackets: true,
        styleActiveLine: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: true,
        extraKeys: {
          "Ctrl-Space": "autocomplete", // é–‹å•Ÿè‡ªå‹•è£œå…¨
          Tab: function (cm) {
            if (cm.somethingSelected()) {
              cm.indentSelection("add");
            } else {
              cm.replaceSelection("    ", "end", "+input");
            }
          },
          "Ctrl-/": "toggleComment", // åˆ‡æ›è¨»é‡‹
          "Ctrl-F": function (cm) {
            // ç°¡å–®çš„æ ¼å¼åŒ–åŠŸèƒ½
            formatCode();
          },
          Enter: function (cm) {
            const pos = cm.getCursor();
            const line = cm.getLine(pos.line);
            const before = line.slice(0, pos.ch);
            const after = line.slice(pos.ch);
            
            // æ”¹é€²çš„æ‹¬è™Ÿé–“æ›è¡Œé‚è¼¯
            if (before.trim().endsWith("{") && after.trim().startsWith("}")) {
              const indentUnit = cm.getOption("indentUnit");
              const currentIndent = line.match(/^\s*/)[0];
              const newIndent = currentIndent + " ".repeat(indentUnit);
              
              // å‰µå»ºå…©è¡Œï¼Œä¸€è¡Œç”¨æ–¼æ”¾ç½®æ–°ä»£ç¢¼ï¼Œå¦ä¸€è¡Œç”¨æ–¼å³æ‹¬è™Ÿ
              cm.replaceSelection(
                "\n" + newIndent + "\n" + currentIndent,
                "around"
              );
              cm.setCursor({ line: pos.line + 1, ch: newIndent.length });
              return;
            }
            
            // å°å…¶ä»–æƒ…æ³çš„æ™ºèƒ½æ›è¡Œè™•ç†
            if (before.trim().endsWith("{") && !after.trim()) {
              // å·¦æ‹¬è™Ÿå¾Œé¢æ²’æœ‰å…§å®¹ï¼Œè‡ªå‹•ç¸®é€²
              const indentUnit = cm.getOption("indentUnit");
              const currentIndent = line.match(/^\s*/)[0];
              const newIndent = currentIndent + " ".repeat(indentUnit);
              
              cm.replaceSelection("\n" + newIndent);
              cm.setCursor({ line: pos.line + 1, ch: newIndent.length });
              return;
            }
            
            // è™•ç†åˆ†è™Ÿå¾Œæ›è¡Œ
            if (before.trim().endsWith(";") && !after.trim()) {
              cm.execCommand("newlineAndIndent");
              return;
            }
            
            // é»˜èªæ›è¡Œè¡Œç‚º
            cm.execCommand("newlineAndIndent");
          },
        },
        hintOptions: {
          completeSingle: false, // ä¸è¦è‡ªå‹•é¸æ“‡å–®ä¸€å»ºè­°
        },
      });

      // å®šç¾©ä¸€å€‹è‡ªå®šç¾©çš„æç¤ºæº (Java æ–¹æ³•è£œå…¨)
      function javaHints(editor) {
        var cursor = editor.getCursor();
        var token = editor.getTokenAt(cursor);
        var query = token.string.toLowerCase();

        // å®šç¾©ä¸€å€‹æ“´å±•çš„Javaå‡½æ•¸åº«
        var suggestions = [
          // ç³»çµ±ç›¸é—œ
          "System.out.println",
          "System.out.print",
          "System.out.printf",
          "System.currentTimeMillis",
          "System.exit",
          "System.getProperty",
          "System.arraycopy",

          // å­—ç¬¦ä¸²ç›¸é—œ
          "String.valueOf",
          "String.format",
          "String.join",
          "String.trim",
          "String.substring",
          "String.toLowerCase",
          "String.toUpperCase",
          "String.replace",
          "String.split",
          "String.charAt",
          "String.equals",
          "String.equalsIgnoreCase",
          "String.contains",
          "String.startsWith",
          "String.endsWith",
          "String.indexOf",
          "String.lastIndexOf",
          "String.length",

          // æ•¸çµ„ç›¸é—œ
          "Arrays.toString",
          "Arrays.sort",
          "Arrays.fill",
          "Arrays.copyOf",
          "Arrays.asList",
          "Arrays.stream",
          "Arrays.binarySearch",

          // é›†åˆç›¸é—œ
          "List",
          "ArrayList",
          "LinkedList",
          "Map",
          "HashMap",
          "TreeMap",
          "Set",
          "HashSet",
          "TreeSet",
          "Collections.sort",
          "Collections.reverse",
          "Collections.shuffle",
          "Collections.max",
          "Collections.min",

          // æµç›¸é—œ
          "Stream.of",
          "Stream.forEach",
          "Stream.map",
          "Stream.filter",
          "Stream.reduce",
          "Stream.collect",

          // Javaé—œéµå­—
          "public",
          "private",
          "protected",
          "static",
          "final",
          "void",
          "int",
          "double",
          "float",
          "long",
          "boolean",
          "char",
          "byte",
          "short",
          "class",
          "interface",
          "enum",
          "extends",
          "implements",
          "throws",
          "throw",
          "try",
          "catch",
          "finally",
          "if",
          "else",
          "switch",
          "case",
          "default",
          "break",
          "continue",
          "return",
          "for",
          "while",
          "do",
          "new",
          "this",
          "super",
          "import",
          "package",
          "instanceof",
          "true",
          "false",
          "null",
          "abstract",
          "assert",
          "synchronized",
        ];

        // æ ¹æ“šç•¶å‰è¼¸å…¥éæ¿¾å€™é¸é …
        var filteredSuggestions = suggestions.filter(function (item) {
          return item.toLowerCase().indexOf(query) !== -1; // åŒ…å«ç•¶å‰æŸ¥è©¢å­—ä¸²ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
        });

        return {
          list: filteredSuggestions,
          from: CodeMirror.Pos(cursor.line, token.start),
          to: CodeMirror.Pos(cursor.line, token.end),
        };
      }

      // è¨»å†Šè‡ªå®šç¾©æç¤ºæº
      CodeMirror.registerHelper("hint", "text/x-java", javaHints);

      // å•Ÿç”¨è‡ªå®šç¾©çš„è£œå…¨
      editor.on("inputRead", function (editor, change) {
        if (change.origin !== "paste") {
          setTimeout(function () {
            if (!editor.state.completionActive) {
              editor.showHint({ completeSingle: false });
            }
          }, 150);
        }
      });

      // æ”¹é€²çš„ä»£ç¢¼æ ¼å¼åŒ–åŠŸèƒ½
      function formatCode() {
        const code = editor.getValue();
        // ä½¿ç”¨è¼ƒç‚ºå®Œå–„çš„æ ¼å¼åŒ–é‚è¼¯
        let formattedCode = "";
        let indentLevel = 0;
        let inString = false;
        let inCharLiteral = false;
        let inBlockComment = false;
        let inLineComment = false;
        let lastNonSpaceChar = '';
        let lastChar = '';
        let skipNextChar = false;
        
        const lines = code.split('\n');
        
        for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
          let line = lines[lineIndex].trim();
          
          // è·³éç©ºè¡Œï¼Œä½†ä¿ç•™é©ç•¶çš„ç¸®æ’
          if (line === '') {
            formattedCode += '\n';
            continue;
          }
          
          // è¡Œè¨»é‡‹ä¿æŒåŸæ¨£ï¼Œåƒ…æ·»åŠ é©ç•¶ç¸®æ’
          if (line.startsWith("//")) {
            formattedCode += ' '.repeat(indentLevel * 4) + line + '\n';
            continue;
          }
          
          // è™•ç†æ¯ä¸€è¡Œçš„å­—ç¬¦
          let lineResult = ' '.repeat(indentLevel * 4);
          
          for (let i = 0; i < line.length; i++) {
            if (skipNextChar) {
              skipNextChar = false;
              continue;
            }
            
            const char = line[i];
            const nextChar = line[i + 1] || '';
            
            // è™•ç†è½‰ç¾©å­—ç¬¦
            if (char === '\\' && (inString || inCharLiteral)) {
              lineResult += char;
              if (nextChar) {
                lineResult += nextChar;
                skipNextChar = true;
              }
              continue;
            }
            
            // è™•ç†å­—ç¬¦ä¸²å’Œå­—ç¬¦å­—é¢é‡
            if (char === '"' && !inCharLiteral && !inBlockComment && !inLineComment) {
              inString = !inString;
            } else if (char === "'" && !inString && !inBlockComment && !inLineComment) {
              inCharLiteral = !inCharLiteral;
            }
            
            // è™•ç†è¨»é‡‹
            if (char === '/' && nextChar === '*' && !inString && !inCharLiteral && !inBlockComment && !inLineComment) {
              inBlockComment = true;
            } else if (char === '*' && nextChar === '/' && inBlockComment) {
              inBlockComment = false;
              lineResult += char + nextChar;
              skipNextChar = true;
              continue;
            } else if (char === '/' && nextChar === '/' && !inString && !inCharLiteral && !inBlockComment) {
              inLineComment = true;
            }
            
            // è™•ç†æ‹¬è™Ÿç¸®é€²
            if (!inString && !inCharLiteral && !inBlockComment && !inLineComment) {
              if (char === '{') {
                // å¦‚æœ { å‰é¢æœ‰å…¶ä»–ä»£ç¢¼ï¼Œå…ˆæ›è¡Œ
                if (lineResult.trim().length > 0 && lastNonSpaceChar !== '(') {
                  lineResult = lineResult.trimRight() + ' ';
                }
                lineResult += char;
                indentLevel++;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºé¡ã€æ–¹æ³•æˆ–æ§åˆ¶èªå¥çš„é–‹å§‹æ‹¬è™Ÿ
                const remainingLine = line.slice(i + 1).trim();
                if (remainingLine === '' || remainingLine.startsWith('//')) {
                  // å¦‚æœ { å¾Œé¢æ²’æœ‰ä»£ç¢¼ï¼Œç›´æ¥çµæŸé€™ä¸€è¡Œ
                  formattedCode += lineResult + '\n';
                  lineResult = '';
                  line = ''; // è·³éé€™ä¸€è¡Œå‰©é¤˜éƒ¨åˆ†
                  break;
                }
              } else if (char === '}') {
                if (lineResult.trim() !== '') {
                  // } å‰é¢æœ‰å…¶ä»–ä»£ç¢¼ï¼Œéœ€è¦æ›è¡Œè™•ç†
                  formattedCode += lineResult.trimRight() + '\n';
                  lineResult = ' '.repeat(Math.max(0, indentLevel - 1) * 4);
                } else {
                  // ç¸®é€²æ¸›å°‘ä¸€ç´š
                  indentLevel = Math.max(0, indentLevel - 1);
                  lineResult = ' '.repeat(indentLevel * 4);
                }
                lineResult += char;
                
                // è™•ç† } å¾Œé¢çš„å…§å®¹
                const remainingLine = line.slice(i + 1).trim();
                if (remainingLine.startsWith('else') || remainingLine.startsWith('catch') ||
                    remainingLine.startsWith('finally') || remainingLine.startsWith('while')) {
                  lineResult += ' ';
                } else if (remainingLine && remainingLine !== ';' && !remainingLine.startsWith('//')) {
                  formattedCode += lineResult + '\n';
                  lineResult = ' '.repeat(indentLevel * 4);
                }
              } else if (char === ';') {
                lineResult += char;
                
                // å¦‚æœåˆ†è™Ÿå¾Œé‚„æœ‰éè¨»é‡‹å…§å®¹ï¼Œå‰‡æ›è¡Œ
                const remainingLine = line.slice(i + 1).trim();
                if (remainingLine && !remainingLine.startsWith('//')) {
                  formattedCode += lineResult + '\n';
                  lineResult = ' '.repeat(indentLevel * 4);
                }
              }
            }
            
            // å°‡å­—ç¬¦æ·»åŠ åˆ°çµæœä¸­
            if (lineResult.length > 0 || char.trim() !== '') {
              lineResult += char;
            }
            
            // è¨˜éŒ„æœ€å¾Œä¸€å€‹éç©ºç™½å­—ç¬¦
            if (char.trim() !== '') {
              lastNonSpaceChar = char;
            }
            lastChar = char;
          }
          
          // ä¸€è¡ŒçµæŸï¼ŒåŠ å…¥æ›è¡Œç¬¦
          if (lineResult.trim() !== '') {
            formattedCode += lineResult + '\n';
          }
          
          // è¡Œè¨»é‡‹çµæŸ
          inLineComment = false;
        }
        
        // å»é™¤æœ«å°¾å¤šé¤˜çš„æ›è¡Œç¬¦
        formattedCode = formattedCode.trimRight();
        
        editor.setValue(formattedCode);
      }

      // é¡¯ç¤ºè‡ªè¨‚å½ˆçª—
      function showCustomAlert(message, icon = "âœ“") {
        document.getElementById("alertContent").textContent = message;
        document.getElementById("customAlert").style.display = "block";
        document.getElementById("overlay").style.display = "block";
        document.querySelector(".custom-alert-icon").textContent = icon;
      }

      // é—œé–‰è‡ªè¨‚å½ˆçª—
      document.getElementById("alertOkBtn").addEventListener("click", function() {
        document.getElementById("customAlert").style.display = "none";
        document.getElementById("overlay").style.display = "none";
      });

      // é»æ“Šé®ç½©å±¤ä¹Ÿå¯ä»¥é—œé–‰å½ˆçª—
      document.getElementById("overlay").addEventListener("click", function() {
        document.getElementById("customAlert").style.display = "none";
        document.getElementById("overlay").style.display = "none";
      });

      // è¤‡è£½ç¨‹å¼ç¢¼åŠŸèƒ½
      document.getElementById("copyBtn").addEventListener("click", function () {
        const code = editor.getValue();
        
        // ä½¿ç”¨navigator.clipboard APIè¤‡è£½åˆ°å‰ªè²¼ç°¿
        navigator.clipboard.writeText(code)
          .then(function() {
            showCustomAlert("ç¨‹å¼ç¢¼å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", "âœ“");
          })
          .catch(function(err) {
            // ä½¿ç”¨å‚™ç”¨æ–¹æ³•
            try {
              const textArea = document.createElement("textarea");
              textArea.value = code;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand("copy");
              document.body.removeChild(textArea);
              showCustomAlert("ç¨‹å¼ç¢¼å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", "âœ“");
            } catch (err) {
              showCustomAlert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¨‹å¼ç¢¼ã€‚", "âœ—");
            }
          });
      });

      // ä¸‹è¼‰ç¨‹å¼ç¢¼åŠŸèƒ½
      document.getElementById("downloadBtn").addEventListener("click", function () {
        const code = editor.getValue();
        const blob = new Blob([code], { type: "text/java;charset=utf-8" });
        
        // å¾ç¨‹å¼ç¢¼ä¸­æå–é¡å
        let className = "Main"; // é è¨­é¡å
        const classNameMatch = code.match(/public\s+class\s+(\w+)/);
        if (classNameMatch && classNameMatch[1]) {
          className = classNameMatch[1];
        }
        
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = className + ".java";
        link.click();
        
        // é‡‹æ”¾URLç‰©ä»¶
        setTimeout(() => {
          URL.revokeObjectURL(link.href);
        }, 100);
        
        showCustomAlert(`å·²ä¸‹è¼‰ç‚º ${className}.java æª”æ¡ˆï¼`, "â¬‡ï¸");
      });

      // æ¸…é™¤æŒ‰éˆ•åŠŸèƒ½
      document.getElementById("clearBtn").addEventListener("click", function () {
        editor.setValue(`public class Main {
    public static void main(String[] args) {
        
    }
}`);
        showCustomAlert("ç·¨è¼¯å™¨å·²æ¸…ç©ºï¼", "ğŸ—‘ï¸");
      });

      // ç•¶è¡¨å–®æäº¤æ™‚ï¼Œå°‡ CodeMirror çš„å…§å®¹æäº¤åˆ°å¾Œç«¯
      document.getElementById("codeForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const code = editor.getValue(); // å–å¾— CodeMirror ç·¨è¼¯å™¨çš„å…§å®¹

        // é¡¯ç¤ºåŠ è¼‰ä¸­ç‹€æ…‹
        document.getElementById("output").innerText = "æ­£åœ¨ç·¨è­¯ä¸¦åŸ·è¡Œ...";

        fetch("/compile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: code }),
        })
          .then((res) => res.text())
          .then((output) => {
            document.getElementById("output").innerText = output;
          })
          .catch((error) => {
            // å¾Œç«¯æœªé€£æ¥æ™‚çš„æ¨¡æ“¬éŸ¿æ‡‰
            if (code.includes("System.out.println")) {
              const printContent = code.match(
                /System\.out\.println\("(.+?)"\)/
              );
              if (printContent && printContent[1]) {
                document.getElementById("output").innerText =
                  printContent[1] + "\n\nç¨‹å¼åŸ·è¡ŒæˆåŠŸï¼";
              } else {
                document.getElementById("output").innerText =
                  "Hello World!\n\nç¨‹å¼åŸ·è¡ŒæˆåŠŸï¼";
              }
            } else {
              document.getElementById("output").innerText =
                "æ¨¡æ“¬åŸ·è¡Œçµæœï¼š\nHello World!\n\n(æ³¨æ„ï¼šé€™åªæ˜¯å‰ç«¯æ¨¡æ“¬çš„çµæœï¼Œå¯¦éš›ç·¨è­¯éœ€è¦å¾Œç«¯æ”¯æŒ)";
            }
          });
      });
    </script>
  </body>
</html>